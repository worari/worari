<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบการรับรองเวลาราชการตอนเป็นทหาร</title>

    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <!-- Flatpickr (Date Picker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">

    <!-- TailwindCSS for Print -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* ใช้ฟอนต์ Sarabun เป็นหลัก */
        body, h1, h2, h3, h4, h5, h6, .btn, .form-control, .form-select, .card-title, .nav-link, .breadcrumb-item {
            font-family: 'Sarabun', sans-serif;
        }

        /* --- Splash Screen Style --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease-out;
        }

        /* --- Login Page Style --- */
        #login-container {
            min-height: 100vh;
            background: url('https://images.unsplash.com/photo-1576133978840-755f333b6a24?q=80&w=2070&auto=format&fit=crop') no-repeat center center;
            background-size: cover;
        }
        .login-card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        /* --- Main App Layout --- */
        #app-container {
            display: flex;
            min-height: 100vh;
        }
        #sidebar {
            width: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s;
        }
        #main-wrapper {
            flex-grow: 1;
            transition: width 0.3s;
            display: flex;
            flex-direction: column;
        }
        #main-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* Responsive Sidebar */
        @media (max-width: 992px) {
            #sidebar {
                margin-left: -280px;
            }
            #sidebar.active {
                margin-left: 0;
            }
            #main-wrapper.sidebar-active {
                 margin-left: 280px; /* Push content when sidebar is open */
            }
        }

        /* Helper class to hide views */
        .content-view {
            display: none;
        }
        .content-view.active {
            display: block;
        }
        
        /* Custom styles for workflow status */
        .status-badge {
            font-size: 0.9em;
            padding: 0.5em 0.8em;
        }
        .status-pending { background-color: #ffc107 !important; color: #000; }
        .status-approved { background-color: #198754 !important; color: #fff; }
        .status-rejected { background-color: #dc3545 !important; color: #fff; }

        /* Print Styles using Tailwind classes (placeholder) */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-section, #print-section * {
                visibility: visible;
            }
            #print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            /* Example of using Tailwind for print */
            .printable-table {
                @apply w-full text-sm text-left text-gray-500;
            }
            .printable-table thead {
                @apply text-xs text-gray-700 uppercase bg-gray-50;
            }
             .printable-table th, .printable-table td {
                @apply px-6 py-3 border border-gray-300;
            }
        }
        .signature-pad {
            border: 1px dashed #ccc;
            border-radius: .375rem;
            cursor: pointer;
        }
        .signature-pad:hover {
            background-color: #f8f9fa;
        }
        .signature-pad img {
            max-width: 100%;
            max-height: 150px;
        }
        .chart-container .spinner-border {
            position: absolute;
            top: 50%;
            left: 50%;
        }
    </style>
</head>
<body class="bg-light">

    <!-- 1. Splash Screen -->
    <div id="splash-screen">
        <i class="fa-solid fa-shield-halved fa-4x text-success mb-3"></i>
        <h4 class="mb-2">ระบบการรับรองเวลาราชการตอนเป็นทหาร</h4>
        <p>กำลังโหลดข้อมูล... กรุณารอสักครู่</p>
        <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- 2. Login Page -->
    <div id="login-container" class="d-flex justify-content-center align-items-center">
        <div class="card shadow-lg login-card" style="width: 25rem;">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <i class="fa-solid fa-shield-halved fa-3x text-success"></i>
                    <h5 class="card-title mt-3">เข้าสู่ระบบ</h5>
                </div>
                <form id="login-form" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="login-email" class="form-label">ชื่อผู้ใช้งาน (อีเมล)</label>
                        <input type="email" class="form-control" id="login-email" required>
                        <div class="invalid-feedback">กรุณากรอกอีเมลให้ถูกต้อง</div>
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">รหัสผ่าน</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="login-password" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                         <div class="invalid-feedback">กรุณากรอกรหัสผ่าน</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">เข้าสู่ระบบ</button>
                    </div>
                </form>
                <div class="text-center mt-3">
                    <a href="#" class="text-decoration-none" id="forgot-password-link">ลืมรหัสผ่าน?</a>
                    <hr>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#register-modal">
                        ลงทะเบียนขอเข้าใช้งานใหม่
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Registration Modal -->
    <div class="modal fade" id="register-modal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="registerModalLabel">ลงทะเบียนผู้ใช้งานใหม่</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="register-form">
              <div class="mb-3">
                <label for="register-email" class="form-label">อีเมล</label>
                <input type="email" class="form-control" id="register-email" required>
              </div>
              <div class="mb-3">
                <label for="register-phone" class="form-label">เบอร์โทรศัพท์</label>
                <input type="tel" class="form-control" id="register-phone" placeholder="08xxxxxxxx" required>
              </div>
              <div class="mb-3">
                <label for="register-password" class="form-label">รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)</label>
                <input type="password" class="form-control" id="register-password" required>
              </div>
              <button type="submit" class="btn btn-primary w-100">ลงทะเบียน</button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- 3. Main Application -->
    <div id="app-container" class="d-none">
        <!-- Sidebar -->
        <aside id="sidebar" class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark">
            <a href="#" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <i class="fa-solid fa-shield-halved fa-2x me-2"></i>
                <span class="fs-5">ระบบรับรองเวลาฯ</span>
            </a>
            <hr>
            <div id="user-profile" class="text-center mb-3">
                <img src="https://placehold.co/80x80/6c757d/fff?text=User" class="rounded-circle mb-2" alt="User" id="user-avatar">
                <h6 id="user-name">ชื่อผู้ใช้งาน</h6>
                <span class="badge bg-success" id="user-role">บทบาท</span>
            </div>
            <hr>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="#" class="nav-link text-white active" data-view="dashboard-view">
                        <i class="fa-solid fa-chart-pie me-2"></i> รายงาน (แดชบอร์ด)
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link text-white" data-view="require-view">
                        <i class="fa-solid fa-file-pen me-2"></i> ยื่นขอรับรอง
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link text-white" data-view="status-view">
                        <i class="fa-solid fa-magnifying-glass-chart me-2"></i> ติดตามสถานะ
                    </a>
                </li>
                <li class="nav-item-role" data-roles="แอดมิน,ผู้ตรวจสอบ,ผู้บังคับบัญชา">
                    <a href="#" class="nav-link text-white" data-view="document-view">
                        <i class="fa-solid fa-file-signature me-2"></i> รับรองเวลาราชการ
                    </a>
                </li>
                <li class="nav-item-role" data-roles="แอดมิน">
                    <a href="#" class="nav-link text-white" data-view="admin-view">
                        <i class="fa-solid fa-users-gear me-2"></i> จัดการผู้ใช้งาน
                    </a>
                </li>
            </ul>
            <hr>
            <button class="btn btn-outline-danger" id="logout-button">
                <i class="fa-solid fa-right-from-bracket me-2"></i> ออกจากระบบ
            </button>
        </aside>

        <!-- Main Wrapper (Navbar + Content) -->
        <div id="main-wrapper">
            <!-- Top Navbar -->
            <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
                <div class="container-fluid">
                    <button class="btn btn-light d-lg-none" type="button" id="sidebar-toggle">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <h5 class="mb-0" id="page-title">รายงาน (แดชบอร์ด)</h5>
                </div>
            </nav>

            <!-- Main Content -->
            <main id="main-content" class="p-4">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="content-view active">
                    <div class="row mb-4">
                        <div class="col-md-8">
                           <h4>สรุปภาพรวม</h4>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="dashboard-year-filter">
                                <option value="">กรองตามปี (ทั้งหมด)</option>
                                <option>2568</option>
                                <option>2567</option>
                                <option>2566</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-4">
                        <!-- Summary Cards -->
                        <div class="col-md-4">
                            <div class="card text-white bg-primary">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">เรื่องทั้งหมด</h5>
                                        <p class="card-text fs-2" id="total-requests">0</p>
                                    </div>
                                    <i class="fa-solid fa-folder-open fa-3x"></i>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-4">
                            <div class="card text-white bg-warning">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">รอพิจารณา</h5>
                                        <p class="card-text fs-2" id="pending-requests">0</p>
                                    </div>
                                    <i class="fa-solid fa-hourglass-half fa-3x"></i>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-4">
                            <div class="card text-white bg-success">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">รับรองแล้ว</h5>
                                        <p class="card-text fs-2" id="approved-requests">0</p>
                                    </div>
                                    <i class="fa-solid fa-circle-check fa-3x"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts -->
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body chart-container position-relative">
                                    <h5 class="card-title">ประเภทข้าราชการ</h5>
                                    <canvas id="doughnut-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card h-100">
                                <div class="card-body chart-container position-relative">
                                    <h5 class="card-title">จำนวนเรื่องที่ยื่น (รายเดือน)</h5>
                                    <canvas id="bar-chart-monthly"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body chart-container position-relative">
                                    <h5 class="card-title">ระยะเวลาดำเนินการ (เฉลี่ย/วัน)</h5>
                                    <canvas id="bar-chart-duration"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body chart-container position-relative">
                                    <h5 class="card-title">หน่วยงานที่ยื่นเรื่อง (Top 5)</h5>
                                    <canvas id="bar-chart-units"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Require View -->
                <div id="require-view" class="content-view">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">แบบฟอร์มยื่นคำขอรับรองเวลาราชการ</h5>
                        </div>
                        <div class="card-body">
                            <form id="require-form">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="req-id-card" class="form-label">เลขบัตรประชาชน</label>
                                        <input type="text" class="form-control" id="req-id-card" placeholder="xxxxxxxxxxxxx" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="req-title" class="form-label">คำนำหน้า</label>
                                        <select id="req-title" class="form-select" required>
                                            <option selected disabled value="">เลือก...</option>
                                            <option>นาย</option>
                                            <option>นาง</option>
                                            <option>นางสาว</option>
                                            <option>จ.ส.อ.</option>
                                            <option>ร.อ.</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="req-fname" class="form-label">ชื่อ</label>
                                        <input type="text" class="form-control" id="req-fname" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="req-lname" class="form-label">นามสกุล</label>
                                        <input type="text" class="form-control" id="req-lname" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="req-affiliation" class="form-label">สังกัด</label>
                                        <input type="text" class="form-control" id="req-affiliation" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="req-doc-no" class="form-label">เลขที่หนังสือ</label>
                                        <input type="text" class="form-control" id="req-doc-no">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="req-doc-date" class="form-label">วันที่หนังสือ</label>
                                        <input type="text" class="form-control" id="req-doc-date" placeholder="เลือกวันที่">
                                    </div>
                                    <div class="col-md-12">
                                        <label for="req-type" class="form-label">ประเภทข้าราชการ</label>
                                        <select id="req-type" class="form-select" required>
                                            <option selected value="in-mod">ข้าราชการในกระทรวงกลาโหม</option>
                                            <option value="out-mod">ข้าราชการนอกกระทรวงกลาโหม</option>
                                        </select>
                                    </div>
                                    <hr>
                                    <h5>ไฟล์แนบ (รองรับ .jpg, .png, .pdf)</h5>
                                    
                                    <!-- Attachment Section -->
                                    <div class="row g-3" id="attachment-section">
                                        <!-- Shared Attachments -->
                                        <div class="col-md-6">
                                            <label for="file-id-card" class="form-label">สำเนาบัตร ปชช.</label>
                                            <input class="form-control" type="file" id="file-id-card" accept=".jpg,.png,.pdf,image/*" capture="camera">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="file-gov-card" class="form-label">สำเนาบัตรข้าราชการ</label>
                                            <input class="form-control" type="file" id="file-gov-card" accept=".jpg,.png,.pdf,image/*" capture="camera">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="file-sd3" class="form-label">สด.3</label>
                                            <input class="form-control" type="file" id="file-sd3" accept=".jpg,.png,.pdf,image/*" capture="camera">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="file-sd8" class="form-label">สด.8</label>
                                            <input class="form-control" type="file" id="file-sd8" accept=".jpg,.png,.pdf,image/*" capture="camera">
                                        </div>
                                        
                                        <!-- In MoD Only Attachments -->
                                        <div class="col-md-6 attachment-in-mod">
                                            <label for="file-order-student" class="form-label">คำสั่งบรรจุนักเรียน</label>
                                            <input class="form-control" type="file" id="file-order-student" accept=".jpg,.png,.pdf,image/*" capture="camera">
                                        </div>
                                        <div class="col-md-6 attachment-in-mod">
                                            <label for="file-order-appoint" class="form-label">คำสั่งบรรจุรับราชการ</label>
                                            <input class="form-control" type="file" id="file-order-appoint" accept=".jpg,.png,.pdf,image/*" capture="camera">
                                        </div>
                                        <div class="col-md-6 attachment-in-mod">
                                            <label for="file-order-discharge" class="form-label">คำสั่งให้ออก</label>
                                            <input class="form-control" type="file" id="file-order-discharge" accept=".jpg,.png,.pdf,image/*" capture="camera">
                                        </div>
                                        <div class="col-md-6 attachment-in-mod">
                                            <label for="file-order-release" class="form-label">คำสั่งให้พ้น</label>
                                            <input class="form-control" type="file" id="file-order-release" accept=".jpg,.png,.pdf,image/*" capture="camera">
                                        </div>
                                        <div class="col-md-6 attachment-in-mod">
                                            <label for="file-order-transfer" class="form-label">คำสั่งรับโอน</label>
                                            <input class="form-control" type="file" id="file-order-transfer" accept=".jpg,.png,.pdf,image/*" capture="camera">
                                        </div>
                                        <div class="col-md-6 attachment-in-mod">
                                            <label for="file-order-move" class="form-label">คำสั่งปรับย้าย</label>
                                            <input class="form-control" type="file" id="file-order-move" accept=".jpg,.png,.pdf,image/*" capture="camera">
                                        </div>
                                        <div class="col-md-6 attachment-in-mod">
                                            <label for="file-history" class="form-label">ประวัติ (ทบ.100)</label>
                                            <input class="form-control" type="file" id="file-history" accept=".jpg,.png,.pdf,image/*" capture="camera">
                                        </div>
                                        
                                        <!-- Other Attachments (Shared) -->
                                        <div class="col-md-6">
                                            <label for="file-other" class="form-label">เอกสารอื่นๆ (เช่น ใบเปลี่ยนชื่อ)</label>
                                            <input class="form-control" type="file" id="file-other" accept=".jpg,.png,.pdf,image/*" capture="camera" multiple>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-secondary" id="print-request-btn"><i class="fa-solid fa-print me-2"></i>พิมพ์คำขอ</button>
                                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-paper-plane me-2"></i>ยื่นเรื่อง</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Status View -->
                <div id="status-view" class="content-view">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ติดตามสถานะคำขอ</h5>
                        </div>
                        <div class="card-body">
                            <table id="status-table" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>วันที่รับเรื่อง</th>
                                        <th>เลขที่เอกสาร</th>
                                        <th>ชื่อ-นามสกุล</th>
                                        <th>สถานะ</th>
                                        <th>วันที่ดำเนินการล่าสุด</th>
                                        <th>หมายเหตุ</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Document (Certification) View -->
                <div id="document-view" class="content-view">
                     <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">รับรองเวลาราชการ</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col">
                                    <input type="text" class="form-control" id="doc-search" placeholder="ค้นหาจากเลขบัตร ปชช., ชื่อ, นามสกุล, เลขที่เอกสาร...">
                                </div>
                            </div>
                            <table id="document-table" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>วันที่รับเรื่อง</th>
                                        <th>เลขที่เอกสาร</th>
                                        <th>ชื่อ-นามสกุล</th>
                                        <th>สถานะ</th>
                                        <th>ผู้ตรวจสอบ</th>
                                        <th>ผู้บังคับบัญชา</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Admin View -->
                <div id="admin-view" class="content-view">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">จัดการผู้ใช้งาน</h5>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#user-modal">
                                <i class="fa-solid fa-user-plus me-2"></i>เพิ่มผู้ใช้งาน
                            </button>
                        </div>
                        <div class="card-body">
                             <table id="admin-table" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>อีเมล</th>
                                        <th>ชื่อ</th>
                                        <th>บทบาท</th>
                                        <th>ลายเซ็น</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- This is a hidden div for printing content -->
                <div id="print-section" class="d-none">
                    <h3 class="text-center font-bold text-xl mb-4">ตัวอย่างการพิมพ์ตาราง</h3>
                    <p>ส่วนนี้จะถูกแสดงเมื่อสั่งพิมพ์เท่านั้น และใช้สไตล์จาก Tailwind CSS</p>
                    <table class="printable-table">
                        <thead>
                            <tr>
                                <th>หัวข้อ 1</th>
                                <th>หัวข้อ 2</th>
                                <th>หัวข้อ 3</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ข้อมูล 1.1</td>
                                <td>ข้อมูล 1.2</td>
                                <td>ข้อมูล 1.3</td>
                            </tr>
                             <tr>
                                <td>ข้อมูล 2.1</td>
                                <td>ข้อมูล 2.2</td>
                                <td>ข้อมูล 2.3</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </main>
        </div>
    </div>
    
    <!-- Modals for actions -->
    <!-- User Management Modal -->
    <div class="modal fade" id="user-modal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userModalLabel">เพิ่ม/แก้ไข ผู้ใช้งาน</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="mb-3">
                    <label for="user-email" class="form-label">อีเมล</label>
                    <input type="email" class="form-control" id="user-email" required>
                </div>
                <div class="mb-3">
                    <label for="user-fullname" class="form-label">ชื่อ-นามสกุล</label>
                    <input type="text" class="form-control" id="user-fullname" required>
                </div>
                <div class="mb-3">
                    <label for="user-role-select" class="form-label">บทบาท</label>
                    <select id="user-role-select" class="form-select" required>
                        <option value="ผู้ใช้งานทั่วไป">ผู้ใช้งานทั่วไป (ยื่นเรื่อง)</option>
                        <option value="ผู้ตรวจสอบ">ผู้ตรวจสอบ</option>
                        <option value="ผู้บังคับบัญชา">ผู้บังคับบัญชา</option>
                        <option value="แอดมิน">แอดมิน</option>
                    </select>
                </div>
                <div class="mb-3" id="signature-upload-container" style="display:none;">
                    <label class="form-label">ภาพลายเซ็นต์</label>
                    <div class="signature-pad p-3 text-center" id="signature-pad">
                        <img id="signature-img" src="https://placehold.co/200x80/f0f0f0/6c757d?text=คลิกเพื่ออัปโหลด" alt="Signature">
                    </div>
                    <input type="file" id="signature-file-input" class="d-none" accept="image/png">
                </div>
                <button type="submit" class="btn btn-primary w-100">บันทึกข้อมูล</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Certification Action Modal -->
    <div class="modal fade" id="certify-action-modal" tabindex="-1" aria-labelledby="certifyActionModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="certifyActionModalLabel">ดำเนินการรับรองเอกสาร</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="certify-action-form">
                <input type="hidden" id="certify-request-id">
                <p><strong>เลขที่เอกสาร:</strong> <span id="certify-doc-id"></span></p>
                <p><strong>ชื่อผู้ยื่น:</strong> <span id="certify-requester-name"></span></p>
                <div class="mb-3">
                    <label class="form-label">เอกสารแนบ</label>
                    <div id="certify-attachment-list" class="list-group">
                        <!-- Attachment links will be populated here -->
                    </div>
                </div>
                 <div class="mb-3">
                    <label for="certify-status" class="form-label">ปรับสถานะ</label>
                    <select id="certify-status" class="form-select" required>
                        <option value="รอพิจารณา">รอพิจารณา</option>
                        <option value="ส่งกลับแก้ไข">ส่งกลับแก้ไข</option>
                        <option value="รับรองแล้ว (ผู้ตรวจสอบ)">รับรองแล้ว (ผู้ตรวจสอบ)</option>
                        <option value="รับรองแล้ว (ผู้บังคับบัญชา)">รับรองแล้ว (ผู้บังคับบัญชา)</option>
                    </select>
                </div>
                 <div class="mb-3">
                    <label for="certify-notes" class="form-label">หมายเหตุ (ถึงผู้ยื่นเรื่อง หรือ ผู้บังคับบัญชา)</label>
                    <textarea class="form-control" id="certify-notes" rows="3"></textarea>
                </div>
                <div class="mb-3" id="certify-signature-container">
                    <label class="form-label">ลงนาม</label>
                    <div id="certify-signature-display" class="border p-2 rounded">
                        <!-- Signature of current user will be shown here -->
                         <img src="https://placehold.co/200x80/f0f0f0/6c757d?text=ไม่มีลายเซ็น" alt="Signature" style="max-height: 80px;">
                    </div>
                </div>
                <button type="submit" class="btn btn-success w-100">ยืนยันการดำเนินการ</button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            sendPasswordResetEmail,
            onAuthStateChanged, 
            signOut,
            signInWithPhoneNumber,
            RecaptchaVerifier
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection,
            addDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            query,
            where,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBwWlf9q-VqT6WzlBsSMJCHPEJjR0Pi0Ek",
          authDomain: "sittiapp-58246.firebaseapp.com",
          projectId: "sittiapp-58246",
          storageBucket: "sittiapp-58246.firebasestorage.app",
          messagingSenderId: "817148456795",
          appId: "1:817148456795:web:2ef24e18ee7ed83cc1f47e"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // ทำให้ตัวแปรเข้าถึงได้จากข้างนอก module (สำหรับ event handlers)
        window.auth = auth;
        window.db = db;
        window.storage = storage;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.signOut = signOut;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.where = where;
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.Timestamp = Timestamp;

        // --- AUTH STATE OBSERVER ---
        // ตัวจัดการสถานะการล็อกอินหลักของแอป
        onAuthStateChanged(auth, async (user) => {
            const splashScreen = document.getElementById('splash-screen');
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');

            if (user) {
                // ถ้ามีผู้ใช้ล็อกอินอยู่
                console.log("User is signed in:", user.uid);
                
                // ดึงข้อมูลโปรไฟล์ผู้ใช้จาก Firestore
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    window.currentUser = { uid: user.uid, ...userData }; // เก็บข้อมูลผู้ใช้ปัจจุบัน
                    console.log("User data:", window.currentUser);
                    
                    // ตั้งค่า UI ตามข้อมูลผู้ใช้
                    setupUIForUser(window.currentUser);
                    
                    // แสดงหน้าแอปหลัก
                    loginContainer.classList.add('d-none');
                    appContainer.classList.remove('d-none');
                    switchView('dashboard-view'); // แสดงแดชบอร์ดเป็นหน้าแรก
                } else {
                    // กรณีไม่พบข้อมูลผู้ใช้ใน Firestore (อาจเป็นข้อผิดพลาด)
                    console.error("User document not found in Firestore!");
                    await signOut(auth); // บังคับออกจากระบบ
                }
            } else {
                // ถ้าไม่มีผู้ใช้ล็อกอิน
                console.log("User is signed out");
                window.currentUser = null;
                loginContainer.classList.remove('d-none');
                appContainer.classList.add('d-none');
            }
            // ซ่อน Splash Screen เมื่อตรวจสอบเสร็จ
            splashScreen.style.opacity = '0';
            setTimeout(() => splashScreen.classList.add('d-none'), 500);
        });

    </script>
    
    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery (required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script> <!-- ภาษาไทย -->

    <!-- Custom App Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- GLOBAL VARIABLES & DOM ELEMENTS ---
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const logoutButton = document.getElementById('logout-button');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const pageTitle = document.getElementById('page-title');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const allContentViews = document.querySelectorAll('.content-view');
            const togglePassword = document.getElementById('toggle-password');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            
            let charts = {}; // Object to hold chart instances

            // --- UTILITY FUNCTIONS ---
            // ฟังก์ชันสำหรับแสดงข้อความแจ้งเตือน
            const showAlert = (icon, title, text = '') => {
                Swal.fire({ icon, title, text });
            };

            // --- AUTHENTICATION LOGIC ---
            // จัดการการเข้าสู่ระบบ
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!loginForm.checkValidity()) {
                    e.stopPropagation();
                    loginForm.classList.add('was-validated');
                    return;
                }
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                // Admin & Test Users Hardcoded Login
                if ((email === 'voradorn.aree@gmail.com' && password === '123456') ||
                    (email === 'sitti.dop@gmail.com' && password === '123456')) {
                    
                    window.signInWithEmailAndPassword(window.auth, email, password)
                        .catch(error => {
                            // If user not found, create them
                            if (error.code === 'auth/user-not-found') {
                                console.log(`Creating test user: ${email}`);
                                window.createUserWithEmailAndPassword(window.auth, email, password)
                                .then(userCredential => {
                                    const user = userCredential.user;
                                    const role = email === 'voradorn.aree@gmail.com' ? 'แอดมิน' : 'ผู้ตรวจสอบ';
                                    const name = email === 'voradorn.aree@gmail.com' ? 'วรดร อารี' : 'สิทธิชัย';
                                    // Create user profile in Firestore
                                    const userDocRef = window.doc(window.db, "users", user.uid);
                                    return window.setDoc(userDocRef, {
                                        email: user.email,
                                        name: name,
                                        role: role,
                                        createdAt: new Date()
                                    });
                                })
                                .then(() => {
                                    showAlert('success', 'สร้างบัญชีทดสอบสำเร็จ', 'กำลังเข้าสู่ระบบ...');
                                    // Now sign in
                                    return window.signInWithEmailAndPassword(window.auth, email, password);
                                })
                                .catch(creationError => {
                                    console.error("Error creating test user:", creationError);
                                    showAlert('error', 'เกิดข้อผิดพลาด', creationError.message);
                                });
                            } else {
                                console.error("Login Error:", error);
                                showAlert('error', 'เข้าสู่ระบบไม่สำเร็จ', error.message);
                            }
                        });
                } else {
                     window.signInWithEmailAndPassword(window.auth, email, password)
                        .catch(error => {
                            console.error("Login Error:", error);
                            showAlert('error', 'เข้าสู่ระบบไม่สำเร็จ', 'อีเมลหรือรหัสผ่านไม่ถูกต้อง');
                        });
                }
            });

            // จัดการการลงทะเบียน
            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const phone = document.getElementById('register-phone').value;
                
                window.createUserWithEmailAndPassword(window.auth, email, password)
                    .then(userCredential => {
                        const user = userCredential.user;
                        console.log('User registered:', user.uid);
                        
                        // สร้างโปรไฟล์ใน Firestore
                        const userDocRef = window.doc(window.db, "users", user.uid);
                        return window.setDoc(userDocRef, {
                            email: user.email,
                            phone: phone,
                            name: email.split('@')[0], // ใช้ชื่อจากอีเมลเป็นค่าเริ่มต้น
                            role: 'ผู้ใช้งานทั่วไป', // บทบาทเริ่มต้น
                            createdAt: new Date()
                        });
                    })
                    .then(() => {
                        showAlert('success', 'ลงทะเบียนสำเร็จ!', 'คุณสามารถเข้าสู่ระบบได้แล้ว');
                        const registerModal = bootstrap.Modal.getInstance(document.getElementById('register-modal'));
                        registerModal.hide();
                        registerForm.reset();
                    })
                    .catch(error => {
                        console.error("Registration Error:", error);
                        showAlert('error', 'ลงทะเบียนไม่สำเร็จ', error.message);
                    });
            });

            // จัดการการออกจากระบบ
            logoutButton.addEventListener('click', () => {
                window.signOut(window.auth).catch(error => console.error('Logout Error:', error));
            });
            
            // แสดง/ซ่อนรหัสผ่าน
            togglePassword.addEventListener('click', function () {
                const passwordInput = document.getElementById('login-password');
                const icon = this.querySelector('i');
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });

            // ลืมรหัสผ่าน
            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                Swal.fire({
                    title: 'รีเซ็ตรหัสผ่าน',
                    input: 'email',
                    inputLabel: 'กรุณากรอกอีเมลของคุณเพื่อรับลิงก์รีเซ็ตรหัสผ่าน',
                    inputPlaceholder: 'enter@example.com',
                    showCancelButton: true,
                    confirmButtonText: 'ส่งลิงก์',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed && result.value) {
                        window.sendPasswordResetEmail(window.auth, result.value)
                            .then(() => {
                                showAlert('success', 'ส่งลิงก์สำเร็จ!', 'กรุณาตรวจสอบอีเมลของคุณ');
                            })
                            .catch((error) => {
                                showAlert('error', 'เกิดข้อผิดพลาด', error.message);
                            });
                    }
                });
            });


            // --- UI & NAVIGATION LOGIC ---
            // จัดการ UI ตามบทบาทผู้ใช้
            window.setupUIForUser = (user) => {
                if (!user) return;
                document.getElementById('user-name').textContent = user.name || user.email;
                document.getElementById('user-role').textContent = user.role;
                
                // แสดง/ซ่อนเมนูตามบทบาท
                document.querySelectorAll('.nav-item-role').forEach(item => {
                    const allowedRoles = item.dataset.roles.split(',');
                    if (allowedRoles.includes(user.role)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            };

            // สลับหน้าจอ View
            window.switchView = (viewId) => {
                allContentViews.forEach(view => view.classList.remove('active'));
                const targetView = document.getElementById(viewId);
                if (targetView) {
                    targetView.classList.add('active');
                    
                    // อัปเดต Title และ Active link
                    const activeLink = sidebar.querySelector(`[data-view="${viewId}"]`);
                    if (activeLink) {
                        pageTitle.textContent = activeLink.innerText.trim();
                        document.querySelectorAll('#sidebar .nav-link').forEach(link => link.classList.remove('active'));
                        activeLink.classList.add('active');
                    }
                    
                    // โหลดข้อมูลสำหรับ View นั้นๆ
                    loadDataForView(viewId);
                }
            };

            // จัดการการคลิกเมนู Sidebar
            sidebar.addEventListener('click', (e) => {
                const link = e.target.closest('a.nav-link');
                if (link && link.dataset.view) {
                    e.preventDefault();
                    switchView(link.dataset.view);
                    // ปิด sidebar บนมือถือหลังคลิก
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('active');
                    }
                }
            });
            
            // Toggle sidebar บนมือถือ
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });


            // --- DATA LOADING LOGIC ---
            // โหลดข้อมูลตาม View ที่เลือก
            const loadDataForView = (viewId) => {
                switch(viewId) {
                    case 'dashboard-view':
                        loadDashboardData();
                        break;
                    case 'require-view':
                        initializeRequireForm();
                        break;
                    case 'status-view':
                        loadStatusData();
                        break;
                    case 'document-view':
                        loadDocumentData();
                        break;
                    case 'admin-view':
                        loadAdminData();
                        break;
                }
            };

            // 1. โหลดข้อมูลแดชบอร์ด
            const loadDashboardData = async () => {
                console.log('Loading dashboard data...');
                // ทำลาย Chart เก่าก่อนสร้างใหม่
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });

                // แสดง Spinner ขณะโหลด
                document.querySelectorAll('.chart-container').forEach(c => {
                    if (!c.querySelector('.spinner-border')) {
                       c.insertAdjacentHTML('beforeend', '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>');
                    }
                });


                try {
                    // ดึงข้อมูลทั้งหมดจาก collection 'requests'
                    const requestsCollection = window.collection(window.db, "requests");
                    const querySnapshot = await window.getDocs(requestsCollection);
                    const allRequests = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // --- คำนวณสถิติ ---
                    let totalCount = allRequests.length;
                    let pendingCount = 0;
                    let approvedCount = 0;
                    let typeCounts = { 'in-mod': 0, 'out-mod': 0 };
                    let monthlyCounts = Array(12).fill(0);
                    let unitCounts = new Map();

                    allRequests.forEach(req => {
                        // นับสถานะ
                        if (req.status === 'รอพิจารณา') {
                            pendingCount++;
                        } else if (req.status.includes('รับรองแล้ว')) {
                            approvedCount++;
                        }
                        
                        // นับประเภท
                        if (req.type === 'in-mod') {
                            typeCounts['in-mod']++;
                        } else if (req.type === 'out-mod') {
                            typeCounts['out-mod']++;
                        }

                        // นับรายเดือน
                        const createdAtDate = req.createdAt.toDate();
                        const month = createdAtDate.getMonth();
                        monthlyCounts[month]++;
                        
                        // นับหน่วยงาน
                        const unit = req.affiliation || 'ไม่ระบุ';
                        unitCounts.set(unit, (unitCounts.get(unit) || 0) + 1);
                    });

                    // --- อัปเดตการ์ดสรุป ---
                    document.getElementById('total-requests').textContent = totalCount;
                    document.getElementById('pending-requests').textContent = pendingCount;
                    document.getElementById('approved-requests').textContent = approvedCount;

                    // --- สร้าง Chart ---
                    // กราฟโดนัท: ประเภทข้าราชการ
                    charts.doughnut = new Chart(document.getElementById('doughnut-chart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['ใน กห.', 'นอก กห.'],
                            datasets: [{
                                label: 'ประเภท',
                                data: [typeCounts['in-mod'], typeCounts['out-mod']],
                                backgroundColor: ['rgb(54, 162, 235)', 'rgb(255, 205, 86)'],
                            }]
                        }
                    });
                    
                    // กราฟแท่ง: ยื่นรายเดือน
                    charts.monthly = new Chart(document.getElementById('bar-chart-monthly'), {
                        type: 'bar',
                        data: {
                            labels: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'],
                            datasets: [{
                                label: 'จำนวนเรื่อง',
                                data: monthlyCounts,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                    });
                    
                    // กราฟแท่ง: ระยะเวลาดำเนินการ (ยังคงใช้ข้อมูลจำลอง)
                    charts.duration = new Chart(document.getElementById('bar-chart-duration'), {
                        type: 'bar',
                        data: {
                            labels: ['รับรองแล้ว', 'ส่งกลับแก้ไข', 'รอพิจารณา'],
                            datasets: [{
                                label: 'วัน (ข้อมูลจำลอง)',
                                data: [5, 2, 10],
                                backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                            }]
                        },
                        options: { indexAxis: 'y', scales: { x: { beginAtZero: true } } }
                    });
                    
                    // กราฟแท่ง: หน่วยงาน (Top 5)
                    const sortedUnits = Array.from(unitCounts.entries()).sort((a, b) => b[1] - a[1]);
                    const top5Units = sortedUnits.slice(0, 5);
                    const unitLabels = top5Units.map(unit => unit[0]);
                    const unitData = top5Units.map(unit => unit[1]);

                    charts.units = new Chart(document.getElementById('bar-chart-units'), {
                        type: 'bar',
                        data: {
                            labels: unitLabels,
                            datasets: [{
                                label: 'จำนวนเรื่อง',
                                data: unitData,
                                backgroundColor: '#6f42c1',
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                    });

                } catch (error) {
                    console.error("Error loading dashboard data:", error);
                    showAlert('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลแดชบอร์ดได้');
                } finally {
                    // ซ่อน Spinner เมื่อโหลดเสร็จ
                    document.querySelectorAll('.chart-container .spinner-border').forEach(spinner => spinner.remove());
                }
            };

            // เพิ่ม Event Listener สำหรับฟิลเตอร์ปี
            document.getElementById('dashboard-year-filter').addEventListener('change', loadDashboardData);


            // 2. ตั้งค่าฟอร์มยื่นคำขอ
            const initializeRequireForm = () => {
                console.log('Initializing require form...');
                // ตั้งค่า Datepicker
                flatpickr("#req-doc-date", {
                    locale: "th",
                    dateFormat: "d/m/Y",
                });
                
                const reqTypeSelect = document.getElementById('req-type');
                const inModAttachments = document.querySelectorAll('.attachment-in-mod');
                
                // จัดการการแสดงฟิลด์ไฟล์แนบตามประเภทข้าราชการ
                const handleAttachmentVisibility = () => {
                    const selectedType = reqTypeSelect.value;
                    if (selectedType === 'in-mod') {
                        inModAttachments.forEach(el => el.style.display = 'block');
                    } else {
                        inModAttachments.forEach(el => el.style.display = 'none');
                    }
                };
                
                reqTypeSelect.addEventListener('change', handleAttachmentVisibility);
                handleAttachmentVisibility(); // เรียกครั้งแรกเมื่อโหลด
                
                // จัดการการยื่นฟอร์ม
               // ในฟังก์ชัน initializeRequireForm
const requireForm = document.getElementById('require-form');
requireForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    // เพิ่มการตรวจสอบความถูกต้องของฟอร์มของ Bootstrap
    if (!requireForm.checkValidity()) {
        e.stopPropagation();
        requireForm.classList.add('was-validated');
        showAlert('error', 'ข้อมูลไม่สมบูรณ์', 'กรุณากรอกข้อมูลในฟอร์มให้ครบถ้วนและถูกต้อง');
        return;
    }
    requireForm.classList.remove('was-validated'); // ลบ class ออกเมื่อข้อมูลถูกต้อง

    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> กำลังบันทึก...';

    let docRef; // ประกาศตัวแปร docRef ไว้ด้านนอก try-catch เพื่อให้เข้าถึงได้ใน catch block

    try {
        const docDateValue = document.getElementById('req-doc-date').value;
        let docDateTimestamp = null;
        if (docDateValue) {
            // แปลงวันที่จาก "d/m/Y" เป็น object วันที่
            const parts = docDateValue.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                const year = parseInt(parts[2], 10);
                docDateTimestamp = window.Timestamp.fromDate(new Date(year, month, day));
            } else {
                console.warn("Invalid date format for docDate:", docDateValue);
                // ถ้าวันที่ไม่ถูกต้อง อาจจะตั้งเป็น null หรือ Timestamp.now() แทน
                docDateTimestamp = window.Timestamp.now();
            }
        }


        const initialFormData = {
            requesterId: window.currentUser.uid,
            requesterName: window.currentUser.name || 'ไม่ระบุชื่อ', // เพิ่มค่า default กัน undefined
            idCard: document.getElementById('req-id-card').value || '',
            title: document.getElementById('req-title').value || '',
            firstName: document.getElementById('req-fname').value || '',
            lastName: document.getElementById('req-lname').value || '',
            affiliation: document.getElementById('req-affiliation').value || '',
            docNo: document.getElementById('req-doc-no').value || '',
            docDate: docDateTimestamp, // ใช้ Timestamp ที่แปลงแล้ว
            type: document.getElementById('req-type').value || 'in-mod',
            status: 'รอพิจารณา',
            createdAt: window.Timestamp.now(),
            history: [{
                status: 'รอพิจารณา',
                date: window.Timestamp.now(),
                actor: window.currentUser.email || 'system', // ใช้ email ผู้ใช้งาน
                notes: 'ยื่นเรื่องเข้าระบบ'
            }],
            attachments: {}
        };

        // --- Debugging: ตรวจสอบข้อมูลก่อนส่ง ---
        console.log("Data being sent to Firestore:", initialFormData);
        // ตรวจสอบว่ามีฟิลด์ใดเป็น undefined หรือไม่
        for (const key in initialFormData) {
            if (initialFormData[key] === undefined) {
                console.warn(`Field '${key}' is undefined. This might cause issues.`);
            }
        }
        // --- End Debugging ---

        docRef = await window.addDoc(window.collection(window.db, "requests"), initialFormData);
        const requestId = docRef.id;

        showAlert('success', 'ยื่นเรื่องสำเร็จ!', `เลขที่เอกสารของคุณคือ ${requestId}. กำลังอัปโหลดไฟล์...`);

        // ส่วนอัปโหลดไฟล์ (จะพูดถึงในหัวข้อถัดไป)
        const fileInputs = document.querySelectorAll('#attachment-section input[type="file"]');
        const uploadPromises = [];
        for (const input of fileInputs) {
            if (input.files.length > 0) {
                const file = input.files[0];
                const storageRef = window.ref(window.storage, `requests/${requestId}/${input.id}-${file.name}`);
                uploadPromises.push(
                    window.uploadBytes(storageRef, file)
                    .then(snapshot => window.getDownloadURL(snapshot.ref))
                    .then(downloadURL => ({
                        id: input.id,
                        url: downloadURL
                    }))
                    .catch(fileError => {
                        console.error(`Error uploading file ${input.id}:`, fileError);
                        showAlert('warning', 'อัปโหลดไฟล์บางส่วนไม่สำเร็จ', `ไฟล์ ${input.id} ไม่สามารถอัปโหลดได้: ${fileError.message}`);
                        return null; // ส่ง null กลับมาเพื่อไม่ให้ Promise.all หยุดทำงาน
                    })
                );
            }
        }

        const uploadedFiles = await Promise.all(uploadPromises);
        const attachmentUrls = uploadedFiles.filter(Boolean).reduce((acc, file) => { // กรองค่าที่เป็น null ออก
            acc[file.id] = file.url;
            return acc;
        }, {});

        if (Object.keys(attachmentUrls).length > 0) {
            await window.updateDoc(docRef, {
                attachments: attachmentUrls
            });
            showAlert('success', 'อัปโหลดไฟล์สำเร็จ!', 'เอกสารของคุณพร้อมใช้งานแล้ว');
        } else {
             showAlert('info', 'ไม่มีไฟล์ให้อัปโหลด', 'คำขอของคุณถูกบันทึกแล้ว แต่ไม่มีไฟล์แนบ');
        }

        requireForm.reset();
        handleAttachmentVisibility();
        switchView('status-view'); // พาผู้ใช้ไปยังหน้าติดตามสถานะหลังจากยื่นเรื่องสำเร็จ

    } catch (error) {
        console.error("Error submitting request: ", error);
        // แสดงข้อความ error ที่เฉพาะเจาะจงมากขึ้น
        let errorMessage = 'ไม่สามารถยื่นเรื่องได้ กรุณาลองใหม่อีกครั้ง';
        if (error.code) {
            errorMessage += ` (Code: ${error.code})`;
        }
        showAlert('error', 'เกิดข้อผิดพลาด', errorMessage);

        // หากมีการสร้างเอกสารใน Firestore แล้ว แต่มีปัญหาในการอัปโหลดไฟล์
        // พิจารณาว่าจะลบเอกสารออกหรือไม่ ขึ้นอยู่กับ business logic ของคุณ
        // if (docRef && docRef.id) {
        //     console.warn(`Deleting partially created document: ${docRef.id}`);
        //     await window.deleteDoc(docRef);
        // }
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane me-2"></i>ยื่นเรื่อง';
    }
});
            
            // 3. โหลดข้อมูลตารางติดตามสถานะ
            const loadStatusData = async () => {
                console.log('Loading status data...');
                const tableId = '#status-table';
                if ($.fn.DataTable.isDataTable(tableId)) {
                    $(tableId).DataTable().destroy();
                }
                
                const tableBody = document.querySelector('#status-table tbody');
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">กำลังโหลดข้อมูล...</td></tr>';
                
                // TODO: ควร Query เฉพาะของผู้ใช้ที่ล็อกอินอยู่
                const q = window.query(window.collection(window.db, "requests"));
                const querySnapshot = await window.getDocs(q);
                
                let rowsHtml = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const latestHistory = data.history[data.history.length - 1];
                    rowsHtml += `
                        <tr>
                            <td>${new Date(data.createdAt.seconds * 1000).toLocaleDateString('th-TH')}</td>
                            <td>${doc.id}</td>
                            <td>${data.title}${data.firstName} ${data.lastName}</td>
                            <td><span class="badge rounded-pill status-${data.status.includes('รับรอง') ? 'approved' : data.status.includes('แก้ไข') ? 'rejected' : 'pending'}">${data.status}</span></td>
                            <td>${new Date(latestHistory.date.seconds * 1000).toLocaleString('th-TH')}</td>
                            <td>${latestHistory.notes || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-info" title="ดูรายละเอียด"><i class="fa-solid fa-eye"></i></button>
                                <button class="btn btn-sm btn-warning" title="แก้ไข"><i class="fa-solid fa-pencil"></i></button>
                                <button class="btn btn-sm btn-success" title="พิมพ์เอกสารรับรอง"><i class="fa-solid fa-print"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = rowsHtml || '<tr><td colspan="7" class="text-center">ไม่พบข้อมูล</td></tr>';
                $(tableId).DataTable({
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/th.json' }
                });
            };
            
            // 4. โหลดข้อมูลตารางรับรองเอกสาร
            const loadDocumentData = async () => {
                console.log('Loading document data for certification...');
                 const tableId = '#document-table';
                if ($.fn.DataTable.isDataTable(tableId)) {
                    $(tableId).DataTable().destroy();
                }
                
                const tableBody = document.querySelector('#document-table tbody');
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">กำลังโหลดข้อมูล...</td></tr>';
                
                const q = window.query(window.collection(window.db, "requests"));
                const querySnapshot = await window.getDocs(q);
                
                let rowsHtml = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    rowsHtml += `
                        <tr>
                            <td>${new Date(data.createdAt.seconds * 1000).toLocaleDateString('th-TH')}</td>
                            <td>${doc.id}</td>
                            <td>${data.title}${data.firstName} ${data.lastName}</td>
                            <td><span class="badge rounded-pill status-${data.status.includes('รับรอง') ? 'approved' : data.status.includes('แก้ไข') ? 'rejected' : 'pending'}">${data.status}</span></td>
                            <td>${data.verifierName || '-'}</td>
                            <td>${data.commanderName || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-certify-action" data-id="${doc.id}" title="ดำเนินการ"><i class="fa-solid fa-file-signature"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = rowsHtml || '<tr><td colspan="7" class="text-center">ไม่พบข้อมูล</td></tr>';
                $(tableId).DataTable({
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/th.json' }
                });
            };

            // 5. โหลดข้อมูลตารางจัดการผู้ใช้
            const loadAdminData = async () => {
                console.log('Loading admin data...');
                const tableId = '#admin-table';
                if ($.fn.DataTable.isDataTable(tableId)) {
                    $(tableId).DataTable().destroy();
                }
                
                const tableBody = document.querySelector('#admin-table tbody');
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">กำลังโหลดข้อมูล...</td></tr>';
                
                const querySnapshot = await window.getDocs(window.collection(window.db, "users"));
                
                let rowsHtml = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    rowsHtml += `
                        <tr>
                            <td>${data.email}</td>
                            <td>${data.name || '-'}</td>
                            <td>${data.role}</td>
                            <td>
                                <img src="${data.signatureUrl || 'https://placehold.co/100x40/f0f0f0/ccc?text=N/A'}" alt="signature" style="max-height: 40px;">
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning btn-edit-user" data-id="${doc.id}"><i class="fa-solid fa-user-pen"></i></button>
                                <button class="btn btn-sm btn-danger btn-delete-user" data-id="${doc.id}"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = rowsHtml || '<tr><td colspan="5" class="text-center">ไม่พบข้อมูล</td></tr>';
                $(tableId).DataTable({
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/th.json' }
                });
            };
            
            // --- ACTION HANDLERS (MODALS, CRUD) ---
            
            // จัดการการคลิกปุ่มในตาราง Admin
            $('#admin-table').on('click', '.btn-edit-user', function() {
                const userId = $(this).data('id');
                openUserModal(userId);
            });
            
            $('#admin-table').on('click', '.btn-delete-user', function() {
                const userId = $(this).data('id');
                // TODO: Implement delete user logic with confirmation
                showAlert('warning', 'ยังไม่เปิดใช้งาน', 'ฟังก์ชันลบผู้ใช้งานยังอยู่ในระหว่างการพัฒนา');
            });

            // เปิด Modal สำหรับจัดการผู้ใช้
            const openUserModal = async (userId = null) => {
                const modal = new bootstrap.Modal(document.getElementById('user-modal'));
                const form = document.getElementById('user-form');
                form.reset();
                document.getElementById('signature-img').src = 'https://placehold.co/200x80/f0f0f0/6c757d?text=คลิกเพื่ออัปโหลด';

                if (userId) {
                    // Edit mode
                    const userDoc = await window.getDoc(window.doc(window.db, 'users', userId));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        $('#user-id').val(userId);
                        $('#user-email').val(data.email).prop('disabled', true);
                        $('#user-fullname').val(data.name);
                        $('#user-role-select').val(data.role);
                        if (data.signatureUrl) {
                            $('#signature-img').attr('src', data.signatureUrl);
                        }
                    }
                } else {
                    // Add mode
                    $('#user-id').val('');
                    $('#user-email').prop('disabled', false);
                }
                
                // แสดง/ซ่อนช่องอัปโหลดลายเซ็น
                const roleSelect = document.getElementById('user-role-select');
                const signatureContainer = document.getElementById('signature-upload-container');
                const handleSignatureVisibility = () => {
                    const selectedRole = roleSelect.value;
                    if (['ผู้ตรวจสอบ', 'ผู้บังคับบัญชา'].includes(selectedRole)) {
                        signatureContainer.style.display = 'block';
                    } else {
                        signatureContainer.style.display = 'none';
                    }
                };
                roleSelect.addEventListener('change', handleSignatureVisibility);
                handleSignatureVisibility();
                
                modal.show();
            };
            
            // คลิกเพื่ออัปโหลดลายเซ็น
            $('#signature-pad').on('click', () => {
                $('#signature-file-input').click();
            });
            $('#signature-file-input').on('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        $('#signature-img').attr('src', event.target.result);
                    }
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            // บันทึกข้อมูลผู้ใช้จาก Modal
            $('#user-form').on('submit', async function(e) {
                e.preventDefault();
                const userId = $('#user-id').val();
                const userData = {
                    name: $('#user-fullname').val(),
                    role: $('#user-role-select').val(),
                    email: $('#user-email').val(),
                };
                
                try {
                    // อัปโหลดลายเซ็นถ้ามี
                    const signatureFile = $('#signature-file-input')[0].files[0];
                    if (signatureFile) {
                        const storageRef = window.ref(window.storage, `signatures/${userId || userData.email}.png`);
                        const snapshot = await window.uploadBytes(storageRef, signatureFile);
                        userData.signatureUrl = await window.getDownloadURL(snapshot.ref);
                    }

                    if (userId) { // Update
                        await window.updateDoc(window.doc(window.db, 'users', userId), userData);
                        showAlert('success', 'อัปเดตข้อมูลสำเร็จ');
                    } else { // Add (requires password, handle differently or create user via Auth first)
                         showAlert('info', 'ยังไม่เปิดใช้งาน', 'การเพิ่มผู้ใช้ใหม่จากหน้านี้ยังไม่รองรับ');
                         return;
                    }
                    bootstrap.Modal.getInstance($('#user-modal')).hide();
                    loadAdminData(); // Refresh table
                } catch (error) {
                    console.error("Error saving user:", error);
                    showAlert('error', 'บันทึกไม่สำเร็จ', error.message);
                }
            });

            // จัดการการคลิกปุ่ม "ดำเนินการ" ในตารางรับรอง
            $('#document-table').on('click', '.btn-certify-action', async function() {
                const requestId = $(this).data('id');
                const modal = new bootstrap.Modal(document.getElementById('certify-action-modal'));
                
                const requestDoc = await window.getDoc(window.doc(window.db, 'requests', requestId));
                if (requestDoc.exists()) {
                    const data = requestDoc.data();
                    $('#certify-request-id').val(requestId);
                    $('#certify-doc-id').text(requestId);
                    $('#certify-requester-name').text(`${data.title}${data.firstName} ${data.lastName}`);
                    $('#certify-status').val(data.status);
                    
                    // แสดงไฟล์แนบ
                    const attachmentList = $('#certify-attachment-list');
                    attachmentList.empty();
                    if(data.attachments && Object.keys(data.attachments).length > 0) {
                        for (const [key, url] of Object.entries(data.attachments)) {
                            attachmentList.append(`<a href="${url}" target="_blank" class="list-group-item list-group-item-action">${key}</a>`);
                        }
                    } else {
                        attachmentList.append('<p class="text-muted">ไม่พบไฟล์แนบ</p>');
                    }
                    
                    // แสดงลายเซ็นผู้ดำเนินการ
                    if (window.currentUser.signatureUrl) {
                        $('#certify-signature-display').html(`<img src="${window.currentUser.signatureUrl}" alt="ลายเซ็นของคุณ">`);
                    }

                    modal.show();
                }
            });

        });
    </script>

</body>
</html>
