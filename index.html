<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบการรับรองเวลาราชการตอนเป็นทหาร</title>

    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <!-- Flatpickr (Date Picker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">

    <style>
        /* ใช้ฟอนต์ Sarabun เป็นหลัก */
        body, h1, h2, h3, h4, h5, h6, .btn, .form-control, .form-select, .card-title, .nav-link, .breadcrumb-item, .dataTables_wrapper {
            font-family: 'Sarabun', sans-serif;
        }

        /* --- Splash Screen Style --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease-out;
        }

        /* --- Login Page Style --- */
        #login-container {
            min-height: 100vh;
            background: url('https://images.unsplash.com/photo-1576133978840-755f333b6a24?q=80&w=2070&auto=format&fit=crop') no-repeat center center;
            background-size: cover;
        }
        .login-card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        /* --- Main App Layout --- */
        #app-container {
            display: flex;
            min-height: 100vh;
        }
        #sidebar {
            width: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s;
        }
        #main-wrapper {
            flex-grow: 1;
            transition: width 0.3s;
            display: flex;
            flex-direction: column;
        }
        #main-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        /* Responsive Sidebar */
        @media (max-width: 992px) {
            #sidebar {
                margin-left: -280px;
                position: fixed;
                z-index: 1030;
                height: 100%;
            }
            #sidebar.active {
                margin-left: 0;
            }
        }

        /* Helper class to hide views */
        .content-view {
            display: none;
        }
        .content-view.active {
            display: block;
        }
        
        /* Custom styles for workflow status */
        .status-badge {
            font-size: 0.9em;
            padding: 0.5em 0.8em;
        }
        .status-รอพิจารณา { background-color: #ffc107 !important; color: #000; }
        .status-รับรองแล้ว { background-color: #198754 !important; color: #fff; }
        .status-ส่งกลับแก้ไข { background-color: #dc3545 !important; color: #fff; }

        .signature-pad {
            border: 1px dashed #ccc;
            border-radius: .375rem;
            cursor: pointer;
        }
        .signature-pad:hover {
            background-color: #f8f9fa;
        }
        .signature-pad img {
            max-width: 100%;
            max-height: 150px;
        }
        .chart-container .spinner-border {
            position: absolute;
            top: 50%;
            left: 50%;
        }
    </style>
</head>
<body class="bg-light">

    <!-- 1. Splash Screen -->
    <div id="splash-screen">
        <i class="fa-solid fa-shield-halved fa-4x text-success mb-3"></i>
        <h4 class="mb-2">ระบบการรับรองเวลาราชการตอนเป็นทหาร</h4>
        <p>กำลังโหลดข้อมูล... กรุณารอสักครู่</p>
        <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- 2. Login Page -->
    <div id="login-container" class="d-flex justify-content-center align-items-center">
        <div class="card shadow-lg login-card" style="width: 25rem;">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <i class="fa-solid fa-shield-halved fa-3x text-success"></i>
                    <h5 class="card-title mt-3">เข้าสู่ระบบ</h5>
                </div>
                <form id="login-form" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="login-email" class="form-label">ชื่อผู้ใช้งาน (อีเมล)</label>
                        <input type="email" class="form-control" id="login-email" required>
                        <div class="invalid-feedback">กรุณากรอกอีเมลให้ถูกต้อง</div>
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">รหัสผ่าน</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="login-password" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                         <div class="invalid-feedback">กรุณากรอกรหัสผ่าน</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">เข้าสู่ระบบ</button>
                    </div>
                </form>
                <div class="text-center mt-3">
                    <a href="#" class="text-decoration-none" id="forgot-password-link">ลืมรหัสผ่าน?</a>
                    <hr>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#register-modal">
                        ลงทะเบียนขอเข้าใช้งานใหม่
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Registration Modal -->
    <div class="modal fade" id="register-modal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="registerModalLabel">ลงทะเบียนผู้ใช้งานใหม่</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="register-form" class="needs-validation" novalidate>
              <div class="mb-3">
                <label for="register-name" class="form-label">ชื่อ-นามสกุล</label>
                <input type="text" class="form-control" id="register-name" required>
                <div class="invalid-feedback">กรุณากรอกชื่อ-นามสกุล</div>
              </div>
              <div class="mb-3">
                <label for="register-email" class="form-label">อีเมล</label>
                <input type="email" class="form-control" id="register-email" required>
                 <div class="invalid-feedback">กรุณากรอกอีเมลให้ถูกต้อง</div>
              </div>
              <div class="mb-3">
                <label for="register-password" class="form-label">รหัสผ่าน (อย่างน้อย 6 ตัวอักษร)</label>
                <input type="password" class="form-control" id="register-password" required minlength="6">
                 <div class="invalid-feedback">รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร</div>
              </div>
              <button type="submit" class="btn btn-primary w-100">ลงทะเบียน</button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- 3. Main Application -->
    <div id="app-container" class="d-none">
        <!-- Sidebar -->
        <aside id="sidebar" class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark">
            <a href="#" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
                <i class="fa-solid fa-shield-halved fa-2x me-2"></i>
                <span class="fs-5">ระบบรับรองเวลาฯ</span>
            </a>
            <hr>
            <div id="user-profile" class="text-center mb-3">
                <img src="https://placehold.co/80x80/6c757d/fff?text=User" class="rounded-circle mb-2" alt="User" id="user-avatar">
                <h6 id="user-name">ชื่อผู้ใช้งาน</h6>
                <span class="badge bg-success" id="user-role">บทบาท</span>
            </div>
            <hr>
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item">
                    <a href="#" class="nav-link text-white active" data-view="dashboard-view">
                        <i class="fa-solid fa-chart-pie me-2"></i> แดชบอร์ด
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link text-white" data-view="require-view">
                        <i class="fa-solid fa-file-pen me-2"></i> ยื่นขอรับรอง
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link text-white" data-view="status-view">
                        <i class="fa-solid fa-magnifying-glass-chart me-2"></i> ติดตามสถานะ
                    </a>
                </li>
                <li class="nav-item-role" data-roles="แอดมิน,ผู้ตรวจสอบ,ผู้บังคับบัญชา">
                    <a href="#" class="nav-link text-white" data-view="document-view">
                        <i class="fa-solid fa-file-signature me-2"></i> รับรองเอกสาร
                    </a>
                </li>
                <li class="nav-item-role" data-roles="แอดมิน">
                    <a href="#" class="nav-link text-white" data-view="admin-view">
                        <i class="fa-solid fa-users-gear me-2"></i> จัดการผู้ใช้งาน
                    </a>
                </li>
            </ul>
            <hr>
            <button class="btn btn-outline-danger" id="logout-button">
                <i class="fa-solid fa-right-from-bracket me-2"></i> ออกจากระบบ
            </button>
        </aside>

        <!-- Main Wrapper (Navbar + Content) -->
        <div id="main-wrapper">
            <!-- Top Navbar -->
            <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
                <div class="container-fluid">
                    <button class="btn btn-light d-lg-none" type="button" id="sidebar-toggle">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <h5 class="mb-0" id="page-title">แดชบอร์ด</h5>
                </div>
            </nav>

            <!-- Main Content -->
            <main id="main-content" class="p-4">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="content-view active">
                    <div class="row g-4">
                        <!-- Summary Cards -->
                        <div class="col-md-4">
                            <div class="card text-white bg-primary">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">เรื่องทั้งหมด</h5>
                                        <p class="card-text fs-2" id="total-requests">0</p>
                                    </div>
                                    <i class="fa-solid fa-folder-open fa-3x"></i>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-4">
                            <div class="card text-white bg-warning">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">รอพิจารณา</h5>
                                        <p class="card-text fs-2" id="pending-requests">0</p>
                                    </div>
                                    <i class="fa-solid fa-hourglass-half fa-3x"></i>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-4">
                            <div class="card text-white bg-success">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">รับรองแล้ว</h5>
                                        <p class="card-text fs-2" id="approved-requests">0</p>
                                    </div>
                                    <i class="fa-solid fa-circle-check fa-3x"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body chart-container position-relative">
                                    <h5 class="card-title">ประเภทข้าราชการ</h5>
                                    <canvas id="doughnut-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body chart-container position-relative">
                                    <h5 class="card-title">จำนวนเรื่องที่ยื่น (รายเดือน)</h5>
                                    <canvas id="bar-chart-monthly"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Require View -->
                <div id="require-view" class="content-view">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">แบบฟอร์มยื่นคำขอรับรองเวลาราชการ</h5>
                        </div>
                        <div class="card-body">
                            <form id="require-form" class="needs-validation" novalidate>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="req-id-card" class="form-label">เลขบัตรประชาชน</label>
                                        <input type="text" class="form-control" id="req-id-card" placeholder="xxxxxxxxxxxxx" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label for="req-title" class="form-label">คำนำหน้า</label>
                                        <select id="req-title" class="form-select" required>
                                            <option selected disabled value="">เลือก...</option>
                                            <option>นาย</option>
                                            <option>นาง</option>
                                            <option>นางสาว</option>
                                            <option>จ.ส.อ.</option>
                                            <option>ร.อ.</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="req-fname" class="form-label">ชื่อ</label>
                                        <input type="text" class="form-control" id="req-fname" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="req-lname" class="form-label">นามสกุล</label>
                                        <input type="text" class="form-control" id="req-lname" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="req-affiliation" class="form-label">สังกัด</label>
                                        <input type="text" class="form-control" id="req-affiliation" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="req-doc-no" class="form-label">เลขที่หนังสือ</label>
                                        <input type="text" class="form-control" id="req-doc-no">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="req-doc-date" class="form-label">วันที่หนังสือ</label>
                                        <input type="text" class="form-control" id="req-doc-date" placeholder="เลือกวันที่">
                                    </div>
                                    <div class="col-md-12">
                                        <label for="req-type" class="form-label">ประเภทข้าราชการ</label>
                                        <select id="req-type" class="form-select" required>
                                            <option value="in-mod">ข้าราชการในกระทรวงกลาโหม</option>
                                            <option value="out-mod">ข้าราชการนอกกระทรวงกลาโหม</option>
                                        </select>
                                    </div>
                                    <hr>
                                    <h5>ไฟล์แนบ (จำเป็น, รองรับ .jpg, .png, .pdf)</h5>
                                    
                                    <div class="row g-3" id="attachment-section">
                                        <div class="col-md-6">
                                            <label for="file-id-card" class="form-label">สำเนาบัตร ปชช.</label>
                                            <input class="form-control" type="file" id="file-id-card" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="file-sd8" class="form-label">สด.8</label>
                                            <input class="form-control" type="file" id="file-sd8" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="file-other" class="form-label">เอกสารอื่นๆ (ถ้ามี)</label>
                                            <input class="form-control" type="file" id="file-other" multiple>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-paper-plane me-2"></i>ยื่นเรื่อง</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Status View -->
                <div id="status-view" class="content-view">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ติดตามสถานะคำขอ</h5>
                        </div>
                        <div class="card-body">
                            <table id="status-table" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>วันที่ยื่น</th>
                                        <th>เลขที่อ้างอิง</th>
                                        <th>เรื่อง</th>
                                        <th>สถานะ</th>
                                        <th>อัปเดตล่าสุด</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Document (Certification) View -->
                <div id="document-view" class="content-view">
                     <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">รับรองเอกสาร</h5>
                        </div>
                        <div class="card-body">
                            <table id="document-table" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>วันที่รับเรื่อง</th>
                                        <th>ชื่อ-นามสกุล</th>
                                        <th>ประเภท</th>
                                        <th>สถานะ</th>
                                        <th>ผู้ตรวจสอบ</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Admin View -->
                <div id="admin-view" class="content-view">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">จัดการผู้ใช้งาน</h5>
                        </div>
                        <div class="card-body">
                             <table id="admin-table" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>อีเมล</th>
                                        <th>ชื่อ</th>
                                        <th>บทบาท</th>
                                        <th>ลายเซ็น</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- User Management Modal -->
    <div class="modal fade" id="user-modal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userModalLabel">แก้ไขผู้ใช้งาน</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="mb-3">
                    <label for="user-email" class="form-label">อีเมล</label>
                    <input type="email" class="form-control" id="user-email" readonly>
                </div>
                <div class="mb-3">
                    <label for="user-fullname" class="form-label">ชื่อ-นามสกุล</label>
                    <input type="text" class="form-control" id="user-fullname" required>
                </div>
                <div class="mb-3">
                    <label for="user-role-select" class="form-label">บทบาท</label>
                    <select id="user-role-select" class="form-select" required>
                        <option value="ผู้ใช้งานทั่วไป">ผู้ใช้งานทั่วไป</option>
                        <option value="ผู้ตรวจสอบ">ผู้ตรวจสอบ</option>
                        <option value="ผู้บังคับบัญชา">ผู้บังคับบัญชา</option>
                        <option value="แอดมิน">แอดมิน</option>
                    </select>
                </div>
                <div class="mb-3" id="signature-upload-container" style="display:none;">
                    <label class="form-label">ภาพลายเซ็นต์</label>
                    <div class="signature-pad p-3 text-center" id="signature-pad">
                        <img id="signature-img" src="https://placehold.co/200x80/f0f0f0/6c757d?text=คลิกเพื่ออัปโหลด" alt="Signature">
                    </div>
                    <input type="file" id="signature-file-input" class="d-none" accept="image/png">
                    <div class="form-text">สำหรับ 'ผู้ตรวจสอบ' และ 'ผู้บังคับบัญชา'</div>
                </div>
                <button type="submit" class="btn btn-primary w-100">บันทึกข้อมูล</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Certification Action Modal -->
    <div class="modal fade" id="certify-action-modal" tabindex="-1" aria-labelledby="certifyActionModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="certifyActionModalLabel">ดำเนินการรับรองเอกสาร</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="certify-action-form">
                <input type="hidden" id="certify-request-id">
                <p><strong>เลขที่อ้างอิง:</strong> <span id="certify-doc-id"></span></p>
                <p><strong>ชื่อผู้ยื่น:</strong> <span id="certify-requester-name"></span></p>
                <div class="mb-3">
                    <label class="form-label">เอกสารแนบ</label>
                    <div id="certify-attachment-list" class="list-group"></div>
                </div>
                 <div class="mb-3">
                    <label for="certify-status" class="form-label">การดำเนินการ</label>
                    <select id="certify-status" class="form-select" required>
                        <option value="รับรองแล้ว">รับรองเอกสาร</option>
                        <option value="ส่งกลับแก้ไข">ส่งกลับเพื่อแก้ไข</option>
                    </select>
                </div>
                 <div class="mb-3">
                    <label for="certify-notes" class="form-label">หมายเหตุ (ถึงผู้ยื่นเรื่อง)</label>
                    <textarea class="form-control" id="certify-notes" rows="3" placeholder="เช่น 'กรุณาแนบเอกสาร สด.3 เพิ่มเติม'"></textarea>
                </div>
                <div class="mb-3" id="certify-signature-container">
                    <label class="form-label">ลงนามโดย</label>
                    <div id="certify-signature-display" class="border p-2 rounded bg-light">
                         <img src="https://placehold.co/200x80/f0f0f0/6c757d?text=ไม่มีลายเซ็น" alt="Signature" style="max-height: 80px;">
                    </div>
                </div>
                <button type="submit" class="btn btn-success w-100">ยืนยันการดำเนินการ</button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            sendPasswordResetEmail,
            onAuthStateChanged, 
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection,
            addDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            query,
            where,
            Timestamp,
            onSnapshot,
            orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytesResumable, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBwWlf9q-VqT6WzlBsSMJCHPEJjR0Pi0Ek",
          authDomain: "sittiapp-58246.firebaseapp.com",
          projectId: "sittiapp-58246",
          storageBucket: "sittiapp-58246.firebasestorage.app",
          messagingSenderId: "817148456795",
          appId: "1:817148456795:web:2ef24e18ee7ed83cc1f47e"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Make functions globally available for event handlers
        window.firebase = {
            auth, db, storage,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut,
            doc, setDoc, getDoc, collection, addDoc, getDocs, updateDoc, deleteDoc, query, where, Timestamp, onSnapshot, orderBy,
            ref, uploadBytesResumable, getDownloadURL
        };

        // --- AUTH STATE OBSERVER ---
        onAuthStateChanged(auth, async (user) => {
            const splashScreen = document.getElementById('splash-screen');
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');

            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    window.currentUser = { uid: user.uid, ...userDocSnap.data() };
                    setupUIForUser(window.currentUser);
                    
                    loginContainer.classList.add('d-none');
                    appContainer.classList.remove('d-none');
                    switchView('dashboard-view');
                } else {
                    console.error("User document not found in Firestore!");
                    await signOut(auth);
                }
            } else {
                window.currentUser = null;
                loginContainer.classList.remove('d-none');
                appContainer.classList.add('d-none');
            }
            splashScreen.style.opacity = '0';
            setTimeout(() => splashScreen.classList.add('d-none'), 500);
        });
    </script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>

    <!-- Custom App Logic -->
    <script type="module">
        // This is a module script, it can import from the firebase setup script
        document.addEventListener('DOMContentLoaded', () => {

            const {
                auth, db, storage,
                signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut,
                doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, query, where, Timestamp, onSnapshot, orderBy,
                ref, uploadBytesResumable, getDownloadURL
            } = window.firebase;

            // --- GLOBAL VARIABLES & DOM ELEMENTS ---
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const logoutButton = document.getElementById('logout-button');
            const sidebar = document.getElementById('sidebar');
            const pageTitle = document.getElementById('page-title');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const allContentViews = document.querySelectorAll('.content-view');
            const togglePassword = document.getElementById('toggle-password');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            
            let charts = {};
            let dataTables = {};
            let unsubscribeListeners = []; // To store snapshot listeners

            // --- UTILITY FUNCTIONS ---
            const showAlert = (icon, title, text = '') => Swal.fire({ icon, title, text });
            const showToast = (icon, title) => Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
            }).fire({ icon, title });

            // --- AUTHENTICATION LOGIC ---
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!loginForm.checkValidity()) {
                    e.stopPropagation();
                    loginForm.classList.add('was-validated');
                    return;
                }
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => {
                        console.error("Login Error:", error);
                        showAlert('error', 'เข้าสู่ระบบไม่สำเร็จ', 'อีเมลหรือรหัสผ่านไม่ถูกต้อง');
                    });
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!registerForm.checkValidity()) {
                    e.stopPropagation();
                    registerForm.classList.add('was-validated');
                    return;
                }
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const name = document.getElementById('register-name').value;
                
                createUserWithEmailAndPassword(auth, email, password)
                    .then(userCredential => {
                        const user = userCredential.user;
                        const userDocRef = doc(db, "users", user.uid);
                        return setDoc(userDocRef, {
                            email: user.email,
                            name: name,
                            role: 'ผู้ใช้งานทั่วไป',
                            createdAt: Timestamp.now()
                        });
                    })
                    .then(() => {
                        showAlert('success', 'ลงทะเบียนสำเร็จ!', 'คุณสามารถเข้าสู่ระบบได้แล้ว');
                        bootstrap.Modal.getInstance(document.getElementById('register-modal')).hide();
                        registerForm.reset();
                        registerForm.classList.remove('was-validated');
                    })
                    .catch(error => {
                        console.error("Registration Error:", error);
                        showAlert('error', 'ลงทะเบียนไม่สำเร็จ', error.code === 'auth/email-already-in-use' ? 'อีเมลนี้ถูกใช้งานแล้ว' : error.message);
                    });
            });

            logoutButton.addEventListener('click', () => {
                // Unsubscribe from all listeners before signing out
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];
                signOut(auth).catch(error => console.error('Logout Error:', error));
            });
            
            togglePassword.addEventListener('click', function () {
                const passwordInput = document.getElementById('login-password');
                const icon = this.querySelector('i');
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });

            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                Swal.fire({
                    title: 'รีเซ็ตรหัสผ่าน',
                    input: 'email',
                    inputLabel: 'กรุณากรอกอีเมลของคุณ',
                    inputPlaceholder: 'enter@example.com',
                    showCancelButton: true,
                    confirmButtonText: 'ส่งลิงก์',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed && result.value) {
                        sendPasswordResetEmail(auth, result.value)
                            .then(() => showAlert('success', 'ส่งลิงก์สำเร็จ!', 'กรุณาตรวจสอบอีเมลของคุณ'))
                            .catch((error) => showAlert('error', 'เกิดข้อผิดพลาด', error.message));
                    }
                });
            });


            // --- UI & NAVIGATION LOGIC ---
            window.setupUIForUser = (user) => {
                if (!user) return;
                document.getElementById('user-name').textContent = user.name || user.email;
                document.getElementById('user-role').textContent = user.role;
                document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${user.name || user.email}&background=0D8ABC&color=fff`;
                
                document.querySelectorAll('.nav-item-role').forEach(item => {
                    const allowedRoles = item.dataset.roles.split(',');
                    item.style.display = allowedRoles.includes(user.role) ? 'block' : 'none';
                });
            };

            window.switchView = (viewId) => {
                // Unsubscribe from previous listeners
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];

                allContentViews.forEach(view => view.classList.remove('active'));
                const targetView = document.getElementById(viewId);
                if (targetView) {
                    targetView.classList.add('active');
                    
                    const activeLink = sidebar.querySelector(`[data-view="${viewId}"]`);
                    if (activeLink) {
                        pageTitle.textContent = activeLink.innerText.trim();
                        document.querySelectorAll('#sidebar .nav-link').forEach(link => link.classList.remove('active'));
                        activeLink.classList.add('active');
                    }
                    loadDataForView(viewId);
                }
            };

            sidebar.addEventListener('click', (e) => {
                const link = e.target.closest('a.nav-link');
                if (link && link.dataset.view) {
                    e.preventDefault();
                    switchView(link.dataset.view);
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('active');
                    }
                }
            });
            
            sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('active'));


            // --- DATA LOADING LOGIC ---
            const loadDataForView = (viewId) => {
                switch(viewId) {
                    case 'dashboard-view': loadDashboardData(); break;
                    case 'require-view': initializeRequireForm(); break;
                    case 'status-view': loadStatusData(); break;
                    case 'document-view': loadDocumentData(); break;
                    case 'admin-view': loadAdminData(); break;
                }
            };

            const loadDashboardData = () => {
                Object.values(charts).forEach(chart => chart.destroy());
                document.querySelectorAll('.chart-container .spinner-border').forEach(s => s.remove());
                document.querySelectorAll('.chart-container').forEach(c => c.insertAdjacentHTML('beforeend', '<div class="spinner-border text-primary" role="status"></div>'));

                const q = query(collection(db, "requests"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    let total = 0, pending = 0, approved = 0;
                    let typeCounts = { 'in-mod': 0, 'out-mod': 0 };
                    let monthlyCounts = Array(12).fill(0);

                    querySnapshot.forEach((doc) => {
                        const req = doc.data();
                        total++;
                        if (req.status === 'รอพิจารณา') pending++;
                        else if (req.status === 'รับรองแล้ว') approved++;
                        
                        if (req.type) typeCounts[req.type]++;
                        
                        const month = req.createdAt.toDate().getMonth();
                        monthlyCounts[month]++;
                    });

                    $('#total-requests').text(total);
                    $('#pending-requests').text(pending);
                    $('#approved-requests').text(approved);

                    document.querySelectorAll('.chart-container .spinner-border').forEach(s => s.remove());

                    charts.doughnut = new Chart($('#doughnut-chart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['ใน กห.', 'นอก กห.'],
                            datasets: [{ data: [typeCounts['in-mod'], typeCounts['out-mod']], backgroundColor: ['#0d6efd', '#ffc107'] }]
                        }
                    });
                    
                    charts.monthly = new Chart($('#bar-chart-monthly'), {
                        type: 'bar',
                        data: {
                            labels: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'],
                            datasets: [{ label: 'จำนวนเรื่อง', data: monthlyCounts, backgroundColor: '#198754' }]
                        },
                        options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                    });
                }, (error) => console.error("Error loading dashboard:", error));
                unsubscribeListeners.push(unsubscribe);
            };

            const initializeRequireForm = () => {
                flatpickr("#req-doc-date", { locale: "th", dateFormat: "d/m/Y" });
                const form = document.getElementById('require-form');
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    if (!form.checkValidity()) {
                        e.stopPropagation();
                        form.classList.add('was-validated');
                        return;
                    }
                    
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> กำลังบันทึก...';
                    
                    try {
                        const docDateValue = $('#req-doc-date').val();
                        const formData = {
                            requesterId: window.currentUser.uid,
                            requesterName: window.currentUser.name,
                            idCard: $('#req-id-card').val(),
                            title: $('#req-title').val(),
                            firstName: $('#req-fname').val(),
                            lastName: $('#req-lname').val(),
                            affiliation: $('#req-affiliation').val(),
                            docNo: $('#req-doc-no').val(),
                            docDate: docDateValue ? Timestamp.fromDate(flatpickr.parseDate(docDateValue, "d/m/Y")) : null,
                            type: $('#req-type').val(),
                            status: 'รอพิจารณา',
                            createdAt: Timestamp.now(),
                            updatedAt: Timestamp.now(),
                            history: [{
                                status: 'รอพิจารณา',
                                date: Timestamp.now(),
                                actor: window.currentUser.name,
                                notes: 'ยื่นเรื่องเข้าระบบ'
                            }],
                            attachments: {}
                        };

                        const docRef = await addDoc(collection(db, "requests"), formData);
                        
                        // File Uploads
                        const fileInputs = document.querySelectorAll('#attachment-section input[type="file"]');
                        const uploadPromises = [];
                        for (const input of fileInputs) {
                            if (input.files.length > 0) {
                                for(const file of input.files) {
                                    const filePath = `requests/${docRef.id}/${file.name}`;
                                    const storageRef = ref(storage, filePath);
                                    const uploadTask = uploadBytesResumable(storageRef, file);
                                    uploadPromises.push(new Promise((resolve, reject) => {
                                        uploadTask.on('state_changed', null, 
                                            (error) => reject(error),
                                            async () => {
                                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                                resolve({ id: input.id, name: file.name, url: downloadURL });
                                            }
                                        );
                                    }));
                                }
                            }
                        }
                        
                        const uploadedFiles = await Promise.all(uploadPromises);
                        const attachments = uploadedFiles.reduce((acc, file) => {
                            if (!acc[file.id]) acc[file.id] = [];
                            acc[file.id].push({ name: file.name, url: file.url });
                            return acc;
                        }, {});

                        await updateDoc(docRef, { attachments });

                        showAlert('success', 'ยื่นเรื่องสำเร็จ!', 'ระบบได้บันทึกคำขอของคุณแล้ว');
                        form.reset();
                        form.classList.remove('was-validated');
                        switchView('status-view');

                    } catch (error) {
                        console.error("Error submitting request: ", error);
                        showAlert('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถยื่นเรื่องได้');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane me-2"></i>ยื่นเรื่อง';
                    }
                };
            };

            const loadStatusData = () => {
                const tableId = '#status-table';
                if (dataTables[tableId]) dataTables[tableId].destroy();
                
                const q = query(collection(db, "requests"), where("requesterId", "==", window.currentUser.uid), orderBy("createdAt", "desc"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const tableData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    dataTables[tableId] = $(tableId).DataTable({
                        destroy: true,
                        data: tableData,
                        columns: [
                            { data: 'createdAt', render: data => data ? new Date(data.seconds * 1000).toLocaleDateString('th-TH') : '' },
                            { data: 'id' },
                            { data: null, render: data => `${data.title} ${data.firstName} ${data.lastName}`},
                            { data: 'status', render: data => `<span class="badge rounded-pill status-${data.replace(/\s+/g, '-')}">${data}</span>` },
                            { data: 'updatedAt', render: data => data ? new Date(data.seconds * 1000).toLocaleString('th-TH') : '' },
                            { data: 'id', render: id => `<button class="btn btn-sm btn-info btn-view-details" data-id="${id}"><i class="fa-solid fa-eye"></i></button>` }
                        ],
                        language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/th.json' }
                    });
                });
                unsubscribeListeners.push(unsubscribe);
            };

            const loadDocumentData = () => {
                const tableId = '#document-table';
                if (dataTables[tableId]) dataTables[tableId].destroy();
                
                const q = query(collection(db, "requests"), where("status", "==", "รอพิจารณา"), orderBy("createdAt", "asc"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const tableData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                     dataTables[tableId] = $(tableId).DataTable({
                        destroy: true,
                        data: tableData,
                        columns: [
                            { data: 'createdAt', render: data => data ? new Date(data.seconds * 1000).toLocaleDateString('th-TH') : '' },
                            { data: null, render: data => `${data.title} ${data.firstName} ${data.lastName}`},
                            { data: 'type', render: data => data === 'in-mod' ? 'ใน กห.' : 'นอก กห.' },
                            { data: 'status', render: data => `<span class="badge rounded-pill status-${data.replace(/\s+/g, '-')}">${data}</span>` },
                            { data: 'history', render: data => data.find(h => h.status === 'รับรองแล้ว')?.actor || '-' },
                            { data: 'id', render: id => `<button class="btn btn-sm btn-primary btn-certify-action" data-id="${id}"><i class="fa-solid fa-file-signature"></i></button>` }
                        ],
                        language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/th.json' }
                    });
                });
                unsubscribeListeners.push(unsubscribe);
            };

            const loadAdminData = () => {
                const tableId = '#admin-table';
                if (dataTables[tableId]) dataTables[tableId].destroy();

                const q = query(collection(db, "users"), orderBy("email"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const tableData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    dataTables[tableId] = $(tableId).DataTable({
                        destroy: true,
                        data: tableData,
                        columns: [
                            { data: 'email' },
                            { data: 'name' },
                            { data: 'role' },
                            { data: 'signatureUrl', render: url => url ? `<img src="${url}" style="max-height:40px;">` : 'ไม่มี' },
                            { data: 'id', render: id => `<button class="btn btn-sm btn-warning btn-edit-user" data-id="${id}"><i class="fa-solid fa-user-pen"></i></button>` }
                        ],
                        language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/th.json' }
                    });
                });
                unsubscribeListeners.push(unsubscribe);
            };
            
            // --- ACTION HANDLERS ---
            $('#admin-table').on('click', '.btn-edit-user', async function() {
                const userId = $(this).data('id');
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    $('#user-id').val(userId);
                    $('#user-email').val(data.email);
                    $('#user-fullname').val(data.name);
                    $('#user-role-select').val(data.role).trigger('change');
                    $('#signature-img').attr('src', data.signatureUrl || 'https://placehold.co/200x80/f0f0f0/6c757d?text=คลิกเพื่ออัปโหลด');
                    new bootstrap.Modal(document.getElementById('user-modal')).show();
                }
            });

            $('#user-role-select').on('change', function() {
                const show = ['ผู้ตรวจสอบ', 'ผู้บังคับบัญชา'].includes($(this).val());
                $('#signature-upload-container').toggle(show);
            });

            $('#signature-pad').on('click', () => $('#signature-file-input').click());
            $('#signature-file-input').on('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    $('#signature-img').attr('src', URL.createObjectURL(e.target.files[0]));
                }
            });

            $('#user-form').on('submit', async function(e) {
                e.preventDefault();
                const userId = $('#user-id').val();
                const userData = {
                    name: $('#user-fullname').val(),
                    role: $('#user-role-select').val(),
                };
                
                try {
                    const signatureFile = $('#signature-file-input')[0].files[0];
                    if (signatureFile) {
                        const storageRef = ref(storage, `signatures/${userId}.png`);
                        await uploadBytesResumable(storageRef, signatureFile);
                        userData.signatureUrl = await getDownloadURL(storageRef);
                    }
                    await updateDoc(doc(db, 'users', userId), userData);
                    showToast('success', 'อัปเดตข้อมูลสำเร็จ');
                    bootstrap.Modal.getInstance($('#user-modal')).hide();
                } catch (error) {
                    console.error("Error saving user:", error);
                    showAlert('error', 'บันทึกไม่สำเร็จ', error.message);
                }
            });

            $('#document-table, #status-table').on('click', '.btn-certify-action, .btn-view-details', async function() {
                const requestId = $(this).data('id');
                const requestDoc = await getDoc(doc(db, 'requests', requestId));
                if (requestDoc.exists()) {
                    const data = requestDoc.data();
                    $('#certify-request-id').val(requestId);
                    $('#certify-doc-id').text(requestId);
                    $('#certify-requester-name').text(data.requesterName);
                    $('#certify-status').val(data.status);
                    
                    const attachmentList = $('#certify-attachment-list').empty();
                    if(data.attachments && Object.keys(data.attachments).length > 0) {
                        for (const [key, files] of Object.entries(data.attachments)) {
                           files.forEach(file => {
                                attachmentList.append(`<a href="${file.url}" target="_blank" class="list-group-item list-group-item-action">${file.name}</a>`);
                           });
                        }
                    } else {
                        attachmentList.append('<p class="text-muted">ไม่พบไฟล์แนบ</p>');
                    }
                    
                    $('#certify-signature-display img').attr('src', window.currentUser.signatureUrl || 'https://placehold.co/200x80/f0f0f0/6c757d?text=ไม่มีลายเซ็น');
                    new bootstrap.Modal(document.getElementById('certify-action-modal')).show();
                }
            });

             $('#certify-action-form').on('submit', async function(e) {
                e.preventDefault();
                const requestId = $('#certify-request-id').val();
                const newStatus = $('#certify-status').val();
                const notes = $('#certify-notes').val();
                const requestRef = doc(db, 'requests', requestId);
                
                try {
                    const requestDoc = await getDoc(requestRef);
                    const currentHistory = requestDoc.data().history || [];
                    
                    const newHistoryEntry = {
                        status: newStatus,
                        notes: notes,
                        date: Timestamp.now(),
                        actor: window.currentUser.name,
                        signatureUrl: window.currentUser.signatureUrl || null
                    };

                    await updateDoc(requestRef, {
                        status: newStatus,
                        updatedAt: Timestamp.now(),
                        history: [...currentHistory, newHistoryEntry]
                    });
                    
                    showToast('success', 'ดำเนินการสำเร็จ');
                    bootstrap.Modal.getInstance($('#certify-action-modal')).hide();
                    $(this)[0].reset();
                } catch (error) {
                    console.error("Error updating status: ", error);
                    showAlert('error', 'เกิดข้อผิดพลาด', error.message);
                }
            });

        });
    </script>

</body>
</html>
